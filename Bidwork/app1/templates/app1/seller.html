{%extends "app1/baseSellerBuyer.html"%}

{% block bodydata %}
	{% if user.is_authenticated and user.is_staff%}
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<div class="form-group bg_blue">
						<h5> Welcome <i>{{currentUser.username}} </i><h5>
						<h1><strong>My schedule</strong><h1>
					</div>
					<div class="table">
						<form id="form1">
							<table class="table">
								<tr>
									<th>Week Number</th>
									<th>Week Start Day</th>
									<th>Bidding Start Date</th>
									<th>Bidding Execution Date</th>
									<th>Min Price</th>
									<th>Max Price</th>
									<th>Current Price</th>
									<th>Total Availablity</th>
									<th>Remaining availability</th>
									<th>Last Modified</th>
								</tr>
								{% for sell in sellsObjects %}
								<tr id="tr_data">
									<td data-id="{{ sell.0 }}" data-type="sell.0" hidden>{{ sell.0 }}</td>
									<td style="{{sell.12}}" class="{{sell.13}}" data-id="{{ sell.0 }}" data-type="Week_Number">{{ sell.1 }}</td>
									<td style="{{sell.14}}" data-id="{{ sell.0 }}" data-type="Week_Start_Date">{{ sell.2 }}</td>
									<td style="{{sell.12}}" class="{{sell.13}}" data-id="{{ sell.0 }}" data-type="Start_Date">{{ sell.3 }}</td>
									<td style="{{sell.12}}" class="{{sell.13}}" data-id="{{ sell.0 }}" data-type="End_Date">{{ sell.4 }}</td>
									<td style="{{sell.12}}" class="{{sell.13}}" data-id="{{ sell.0 }}" data-type="Min_Price">{{ sell.5 }}</td>
									<td style="{{sell.12}}" class="{{sell.13}}" data-id="{{ sell.0 }}" data-type="Max_Price">{{ sell.6 }}</td>
									<td style="{{sell.14}}" data-id="{{ sell.0 }}" data-type="Current_price">{{ sell.7 }}</td>
									<td style="{{sell.12}}" class="editable" data-id="{{ sell.0 }}" data-type="Total_Availibility">{{ sell.8 }}</td>
									<td style="{{sell.14}}" data-id="{{ sell.0 }}" data-type="Remaining_availability">{{ sell.9 }}</td>
									<td style="{{sell.14}}" data-id="{{ sell.0 }}" data-type="Post_Date">{{ sell.10 }}</td>
									<td>
									{% if sell.11 == "1" %}
										<a href="/deleteSell/{{sell.0}}" class="btn btn-danger">Delete</a><br>
									{%endif%}
									<input class="btn btn-success update-button" id='{{sell.0}}' value="Update" type="button"/>
									</td>
								</tr>
								{% endfor %}
							</table>
						</form>
					</div>
				</div>
			</div>
			<div class="row">
				<a href="/newSell" class="btn btn-success">Add</a>
				<div class="col-lg-12">
					<div class="form-group bg_blue">
						<h1><strong>Placed Bids</strong><h1>
						</div>
						<div class="table">
							<form id="form2">
								<table class="table">
									<tr>
										<th>Week Number</th>
										<th>Buyer Name</th>
										<th>Unit Price</th>
										<th>Bid Hour</th>									
										<th>Total Price</th>
										<th>Post Date</th>
									</tr>
									{% for bid in bidsObjects %}
										<tr id="tr_data">
											<td  style="{{bid.7}}" data-id="{{ bid.0 }}" data-type="id" hidden>{{ bid.0 }}</td>
											<td  style="{{bid.7}}" data-id="{{ bid.0 }}" data-type="Week_Number">{{ bid.1 }}</td>
											<td  style="{{bid.7}}" data-id="{{ bid.0 }}" data-type="Buyer_Username">{{ bid.2 }}</td>
											<td  style="{{bid.7}}" data-id="{{ bid.0 }}" data-type="Price">{{ bid.3 }}</td>
											<td  style="{{bid.7}}" data-id="{{ bid.0 }}" data-type="Hours">{{ bid.4 }}</td>
											<td  style="{{bid.7}}" data-id="{{ bid.0 }}" data-type="Total">{{ bid.5 }}</td>
											<td  style="{{bid.7}}" data-id="{{ bid.0 }}" data-type="Bidding_Date">{{ bid.6 }}</td>
										</tr>
									{% endfor %}									
								</table>
							</form>
						</div>
					</div>
				</div>
			</div>				
		</div>
	{%else%}
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<div class="form-group bg_blue">
						<h1><strong>Access Denied!</strong><h1>
							<h3>Your credential does not allow to change/view the bidding schedule<h1>
					</div>
				</div>
			</div>
		</div>
	{% endif %}			
{% endblock bodydata %}
{% block custom_js %}
<script>
	$(document).ready(function(){
		$(document).on("dblclick",".editable",function(){
			var value=$(this).text();
			var data_type=$(this).data("type");
			var input_type="text";
			if(data_type=="created_at"){
				input_type="datetime-local";
			}
			if (data_type != "Week_Number") {
				var input = "<input name='selected_sell' type='" + input_type + "' class='input-data' value='" + value + "' class='form-control'>";
			} else {
				var input = "<select name='Week_Number' id='Week_Number'>"
				for (var i = 1; i < 54; i++)
					input += "<option value='" + i + "'>" + i + "</option>";
				input+="</select>"
			}

			$(this).html(input);
			$(this).removeClass("editable")
		});

		$(document).on("click",".update-button",function(e){
			let id = $(this)[0]["id"];
			sendToServer(id);
		});

		$(document).on("blur",".input-data",function(){
			var value=$(this).val();
			var td=$(this).parent("td");
			$(this).remove();
			td.html(value);
			td.addClass("editable");
		});

		$(document).on("change","#Week_Number",function(e){
			let id = $(this)[0];
			var result = new Date("12/29/2019");
			result.setDate(result.getDate() + parseInt(($("#Week_Number").val())-1) * 7);
			$("#form1 td[data-id='" + $(this)[0].parentElement.getAttribute("data-id") + "']")[2].innerText = (result.getYear()+1900)+"-"+(result.getMonth() +1)+"-"+result.getDate()
		});


		$(document).on("keypress",".input-data",function(e){
			var key=e.which;
			if(key==13){
				var value=$(this).val();
				var td=$(this).parent("td");
				$(this).remove();
				td.html(value);
				td.addClass("editable");
			}
		});
		function sendToServer(id){
			$.ajax({
				url:window.location.href.replace("seller","saveSell"),
				type:"POST",
				data:do_serialize(id),
			})
			.done(function(response){
				console.log(response);
					//alert("Update succeeded")
					location.reload();
				})
			.fail(function(){
				console.log("Error Occured");
					//alert("Update failed")
				});
		}

	});
	function do_serialize(id){
		let data = {};
		$('#form1').find('tr').each(function(){
			if ($(this)[0].children[0].innerText === id){
				let row  = $(this)[0];
				if (row.children !== undefined){
					data.id = id;
					data.Week_Number =(row.children[1].children[0] == undefined? row.children[1].textContent:row.children[1].children[0].value);
					data.Start_Date = row.children[3].textContent;
					data.End_Date = row.children[4].textContent;
					data.Min_Price = row.children[5].textContent;
					data.Max_Price = row.children[6].textContent;
					data.Total_Availibility = row.children[8].textContent;
				}
			}
		});
		return data;
	}          
</script>
{% endblock custom_js %}