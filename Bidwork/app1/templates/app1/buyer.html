{%extends "app1/baseSellerBuyer.html"%}

{% block bodydata %}
	{% if user.is_authenticated and not user.is_staff%}	
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<div class="form-group bg_blue">
						<h5> Welcome <i>{{currentUser.username}} </i>, your remaining budget is <i> {{budget}} </i><h5>
						<h1><strong>Seller Schedule</strong><h1>
					</div>
					<div class="table">
						<form id="form1">
							<table class="table">
								<tr>
									<th>Week Number</th>
									<th>Week Start Day</th>
									<th>Bidding Start Date</th>
									<th>Bidding End Date</th>
									<th>Current Price</th>
									<th>Remaining availability</th>
									<th>Last Modified</th>
									<th>Bid Hours</th>
								</tr>
								{% for sell in sellsObjects %}
									<tr id="tr_data">
										<td data-id="{{ sell.0 }}" data-type="sell.id" hidden>{{ sell.0 }}</td>
										<td style="{{sell.9}}" data-id="{{ sell.0 }}" data-type="Week_Number">{{ sell.1 }}</td>
										<td style="{{sell.9}}" data-id="{{ sell.0 }}" data-type="Week_Start_Date">{{ sell.2 }}</td>
										<td style="{{sell.9}}" data-id="{{ sell.0 }}" data-type="Start_Date">{{ sell.3 }}</td>
										<td style="{{sell.9}}" data-id="{{ sell.0 }}" data-type="End_Date">{{ sell.4 }}</td>
										<td style="{{sell.9}}" data-id="{{ sell.0 }}" data-type="Current_price">{{ sell.5 }}</td>
										<td style="{{sell.9}}" data-id="{{ sell.0 }}" data-type="Remaining_availability">{{ sell.6 }}</td>
										<td style="{{sell.9}}" data-id="{{ sell.0 }}" data-type="Post_Date">{{ sell.7}}</td>
										{% if sell.8 == "1"%}
											<td style="color:#00688B; text-decoration: underline" class="editable" data-id="{{ sell.0 }}" data-type="Bid_Hours"> <u>0 </u></td>
											<td><input class="btn btn-success update-button" id="{{sell.0}}" value="Bid" type="button" /></td>
										{%else%}
											<td style="{{sell.9}}" class="editable" data-id="{{ sell.0 }}" data-type="Bid_Hours"> 0</td>		
											<td><input class="btn btn-success update-button" id="{{sell.0}}" value="Bid" type="button" disabled/></td>										
										{% endif %}
									</tr>
								{% endfor %}
							</table>
						</form>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">
					<div class="form-group bg_blue">
						<h1><strong>My Bids</strong><h1>
					</div>
					<div class="table">
						<form id="form2">
							<table class="table">
								<tr>
									<th>Week Number</th>
									<th>Unit Price</th>
									<th>Bid Hour</th>
									<th>Total Price</th>
									<th>Post Date</th>
								</tr>
								{% for bid in bidsObjects %}
									<tr id="tr_data">
										<td style="{{bid.6}}" data-id="{{ bid.0 }}" data-type="id" hidden>{{ bid.0 }}</td>
										<td style="{{bid.6}}" data-id="{{ bid.0 }}" data-type="Week_Number">{{ bid.1 }}</td>
										<td style="{{bid.6}}" data-id="{{ bid.0 }}" data-type="Price">{{ bid.2 }}</td>
										<td style="{{bid.6}}" data-id="{{ bid.0 }}" data-type="Hours">{{ bid.3 }}</td>
										<td style="{{bid.6}}" data-id="{{ bid.0 }}" data-type="Total">{{ bid.4 }}</td>
										<td style="{{bid.6}}" data-id="{{ bid.0 }}" data-type="Bidding_Date">{{ bid.5 }}</td>
									</tr>
								{% endfor %}
							</table>
						</form>
					</div>
				</div>
			</div>
		</div>
	{%else%}
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<div class="form-group bg_blue">
						<h1><strong>Access Denied!</strong><h1>
							<h3>Your credential does not allow submit/view any bid<h1>
					</div>
				</div>
			</div>
		</div>
	{% endif %}
{% endblock bodydata %}

{% block custom_js %}
<script>
	$(document).ready(function(){
		$(document).on("dblclick",".editable",function(){
			var value=$(this).text();
			var data_type=$(this).data("type");
			var input_type="text";
			if(data_type=="created_at"){
				input_type="datetime-local";
			}
			var input="<input name='selected_bid' type='"+input_type+"' class='input-data' value='"+value+"' class='form-control'>";
			$(this).html(input);
			$(this).removeClass("editable")
		});
		$(document).on("dblclick",".editable",function(){
			var value=$(this).text();
			var data_type=$(this).data("type");
			var input_type="text";
			if(data_type=="created_at"){
				input_type="datetime-local";
			}
			var input="<input name='selected_bid' type='"+input_type+"' class='input-data' value='"+value+"' class='form-control'>";
			$(this).html(input);
			$(this).removeClass("editable")
		});

		$(document).on("click",".update-button",function(e){
			let id = $(this)[0]["id"];
			sendToServer(id);

			// if (parseFloat($("#form1 td[data-id='" + id + "']")[8].innerText) >parseFloat($("#form1 td[data-id='" + id + "']")[6].innerText) ){
			// 	alert("No Remaining Hours for the clicked week");//Check to see if there is any available time
			// } else if (isNaN(parseFloat($("#form1 td[data-id='" + id + "']")[8].innerText))) {
			// 	alert("Entered Bid Hours is invalid");//Validation of the bid hour textbox
			// } else if (parseFloat($("#form1 td[data-id='" + id + "']")[8].innerText)<0.0) {
			// 	alert("Bid Hours can't be Negative");//Validation of the bid hour textbox
			// }
			// else {
			// 	//$("#form1 td[data-id='"+id+"']")[6].innerText = parseFloat($("#form1 td[data-id='"+id+"']")[6].innerText) - parseFloat($("#form1 td[data-id='"+id+"']")[8].innerText)//re-calculating the available time
			// 	sendToServer(id);
			// }
		});

		$(document).on("blur",".input-data",function(){
			var value=$(this).val();
			var td=$(this).parent("td");
			$(this).remove();
			td.html(value);
			td.addClass("editable");
		});
		$(document).on("keypress",".input-data",function(e){
			var key=e.which;
			if(key==13){
				var value=$(this).val();
				var td=$(this).parent("td");
				$(this).remove();
				td.html(value);
				td.addClass("editable");
			}
		});
		function sendToServer(id){					
			$.ajax({
				url:window.location.href.replace("buyer","saveBid"),
				type:"POST",
				data:do_serialize(id),
			})
			.done(function(response){
				console.log(response);
				//alert("Update succeeded")
				location.reload();
			})
			.fail(function(){
				//console.log("Error Occured");
				//alert("Update failed")
			});
		}

	});
	function do_serialize(id){
		let data = {};
		$('#form1').find('tr').each(function(){
			if ($(this)[0].children[0].innerText === id){
				let row  = $(this)[0];
				if (row.children !== undefined){
					data.id = id;
					data.Week_Number = row.children[1].textContent;
					data.Price = row.children[5].textContent;
					data.Bid_Hours = row.children[8].textContent;
					var d = new Date($.now());
					data.Bidding_Date =  d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate() + " " + d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();				
				}
			}
		});
		return data;
	}          
</script>
{% endblock custom_js %}